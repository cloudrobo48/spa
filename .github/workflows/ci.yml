name: Terraform CI

on:
  pull_request:
    paths:
      - '**.tf'
      - '.github/workflows/*'

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ap-northeast-1

jobs:
  terraform-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.4

      - name: Determine environment from PR label
        id: env
        run: |
          LABELS=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")
          if echo "$LABELS" | grep -q "env:dev"; then
            echo "ENV_NAME=dev" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "env:prod"; then
            echo "ENV_NAME=prod" >> $GITHUB_OUTPUT
          else
            echo "âŒ Invalid or missing env label. Use 'env:dev' or 'env:prod'."
            exit 1
          fi

      - name: Determine tfvars file
        id: vars
        run: |
          echo "TFVARS=${{ steps.env.outputs.ENV_NAME }}.tfvars" >> $GITHUB_OUTPUT


      - name: Terraform Init
        run: terraform init -backend-config="key=terraform/state.tfstate"

      - name: Select Workspace
        run: terraform workspace select ${{ steps.env.outputs.ENV_NAME }} || terraform workspace new ${{ steps.env.outputs.ENV_NAME }}


      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Install tflint
        run: |
          curl -L https://github.com/terraform-linters/tflint/releases/download/v0.50.3/tflint_linux_amd64.zip -o tflint.zip
          unzip tflint.zip
          chmod +x tflint
          sudo mv tflint /usr/local/bin/
          tflint --version

      - name: Run tflint
        run: tflint --disable-rule=terraform_unused_declarations


      - name: Terraform Plan (check only)
        run: terraform plan -var-file=${{ steps.vars.outputs.TFVARS }}


      - name: Terraform Plan (for review)
        run: terraform plan -no-color -var-file=${{ steps.vars.outputs.TFVARS }} > plan.txt


      - name: Comment plan on PR (update if exists)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.txt', 'utf8');
            const header = '### Terraform Plan ðŸ“¦';


            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });


            const existing = comments.data.find(c => c.body.startsWith(header));

            const body = `${header}\n\`\`\`\n${plan}\n\`\`\``;

            if (existing) {

              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            } else {

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            }
