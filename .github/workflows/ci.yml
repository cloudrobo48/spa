name: Terraform CI

on:
  pull_request:
    paths:
      - '**.tf'
      - '.github/workflows/*'

permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: ap-northeast-1

jobs:
  terraform-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.2  # å®‰å®šç‰ˆã€‚fmtã‚„planã®æŒ™å‹•ãŒå®‰å®š

      - name: Terraform Init
        run: terraform init -backend-config="key=terraform/${{ github.event.inputs.environment }}/state.tfstate"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: terraform validate

      - name: Install tflint
        run: |
          curl -L https://github.com/terraform-linters/tflint/releases/download/v0.50.3/tflint_linux_amd64.zip -o tflint.zip
          unzip tflint.zip
          chmod +x tflint
          sudo mv tflint /usr/local/bin/
          tflint --version

      - name: Run tflint
        run: tflint --disable-rule=terraform_unused_declarations

      - name: Determine tfvars file
        id: vars
        run: |
          if [ "${{ github.base_ref }}" = "main" ]; then
            echo "TFVARS=prod.tfvars" >> $GITHUB_OUTPUT
          else
            echo "TFVARS=dev.tfvars" >> $GITHUB_OUTPUT
          fi

      # 1å›ç›®ã®Planï¼šCIãƒã‚§ãƒƒã‚¯ç”¨ï¼ˆã‚¨ãƒ©ãƒ¼æ¤œå‡ºç”¨ï¼‰
      - name: Terraform Plan (check only)
        run: terraform plan -var-file=${{ steps.vars.outputs.TFVARS }}

      # 2å›ç›®ã®Planï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼ˆplan.txtã«ä¿å­˜ï¼‰
      - name: Terraform Plan (for review)
        run: terraform plan -no-color -var-file=${{ steps.vars.outputs.TFVARS }} > plan.txt

      # PRã‚³ãƒ¡ãƒ³ãƒˆã«Planå†…å®¹ã‚’æŠ•ç¨¿ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼æ‹…å½“è€…ãŒPRç”»é¢ã§ç¢ºèªã§ãã‚‹ï¼‰
      - name: Comment plan on PR (update if exists)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('plan.txt', 'utf8');
            const header = '### Terraform Plan ğŸ“¦';

            //  æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å–å¾—
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            //  Terraform Plan ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¢ã™
            const existing = comments.data.find(c => c.body.startsWith(header));

            const body = `${header}\n\`\`\`\n${plan}\n\`\`\``;

            if (existing) {
              //  ã‚ã‚Œã°æ›´æ–°
              await github.rest.issues.updateComment({
                comment_id: existing.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            } else {
              //  ãªã‘ã‚Œã°æ–°è¦æŠ•ç¨¿
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body,
              });
            }

      #ï¼ˆä»»æ„ï¼‰Planå‡ºåŠ›ã‚’Artifactsã«ä¿å­˜ï¼ˆãƒ­ã‚°ç”¨é€”ï¼‰
      # - name: Upload plan output
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: terraform-plan
      #     path: plan.txt
